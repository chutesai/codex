name: chutes-release-assets
permissions:
  contents: write
  actions: read
on:
  push:
    tags:
      - "chutes-v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to publish (e.g. chutes-v0.0.2). Required for manual runs.
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build_binaries:
    name: Build release binaries â€” ${{ matrix.runner }} - ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    defaults:
      run:
        working-directory: codex-rs
    env:
      # Release assets should be reliable and timely to build. If you need maximum optimization,
      # rebuild locally with `CARGO_PROFILE_RELEASE_LTO=fat` and `CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1`.
      CARGO_PROFILE_RELEASE_LTO: thin
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 16
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            target: aarch64-apple-darwin
            artifact_name: codex-macos-aarch64
          - runner: macos-latest
            target: x86_64-apple-darwin
            artifact_name: codex-macos-x86_64
          - runner: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            artifact_name: codex-linux-x86_64-gnu
          - runner: ubuntu-24.04
            target: x86_64-unknown-linux-musl
            artifact_name: codex-linux-x86_64-musl
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_name: codex-linux-aarch64-gnu
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            artifact_name: codex-linux-aarch64-musl
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: codex-windows-x86_64
          - runner: windows-11-arm
            target: aarch64-pc-windows-msvc
            artifact_name: codex-windows-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.93.0
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux build dependencies
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          packages=(pkg-config libcap-dev)
          if [[ "${{ matrix.target }}" == 'x86_64-unknown-linux-musl' || "${{ matrix.target }}" == 'aarch64-unknown-linux-musl' ]]; then
            packages+=(libubsan1)
          fi
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "${packages[@]}"

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Use hermetic Cargo home (musl)
        shell: bash
        run: |
          set -euo pipefail
          cargo_home="${GITHUB_WORKSPACE}/.cargo-home"
          mkdir -p "${cargo_home}/bin"
          echo "CARGO_HOME=${cargo_home}" >> "$GITHUB_ENV"
          echo "${cargo_home}/bin" >> "$GITHUB_PATH"
          : > "${cargo_home}/config.toml"

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Install Zig (musl)
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.0

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Install musl build tools (musl)
        env:
          DEBIAN_FRONTEND: noninteractive
          TARGET: ${{ matrix.target }}
          APT_UPDATE_ARGS: -o Acquire::Retries=3
          APT_INSTALL_ARGS: --no-install-recommends
        shell: bash
        run: bash "${GITHUB_WORKSPACE}/.github/scripts/install-musl-build-tools.sh"

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Configure rustc UBSan wrapper (musl host)
        shell: bash
        run: |
          set -euo pipefail
          ubsan=""
          if command -v ldconfig >/dev/null 2>&1; then
            ubsan="$(ldconfig -p | grep -m1 'libubsan\.so\.1' | sed -E 's/.*=> (.*)$/\1/')"
          fi
          wrapper_root="${RUNNER_TEMP:-/tmp}"
          wrapper="${wrapper_root}/rustc-ubsan-wrapper"
          cat > "${wrapper}" <<EOF
          #!/usr/bin/env bash
          set -euo pipefail
          if [[ -n "${ubsan}" ]]; then
            export LD_PRELOAD="${ubsan}\${LD_PRELOAD:+:\${LD_PRELOAD}}"
          fi
          exec "\$1" "\${@:2}"
          EOF
          chmod +x "${wrapper}"
          echo "RUSTC_WRAPPER=${wrapper}" >> "$GITHUB_ENV"
          echo "RUSTC_WORKSPACE_WRAPPER=" >> "$GITHUB_ENV"

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Clear sanitizer flags (musl)
        shell: bash
        run: |
          set -euo pipefail
          # Clear global Rust flags so host/proc-macro builds don't pull in UBSan.
          echo "RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_ENCODED_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "RUSTDOCFLAGS=" >> "$GITHUB_ENV"
          # Override any runner-level Cargo config rustflags as well.
          echo "CARGO_BUILD_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS=" >> "$GITHUB_ENV"

          sanitize_flags() {
            local input="$1"
            input="${input//-fsanitize=undefined/}"
            input="${input//-fno-sanitize-recover=undefined/}"
            input="${input//-fno-sanitize-trap=undefined/}"
            echo "$input"
          }

          cflags="$(sanitize_flags "${CFLAGS-}")"
          cxxflags="$(sanitize_flags "${CXXFLAGS-}")"
          echo "CFLAGS=${cflags}" >> "$GITHUB_ENV"
          echo "CXXFLAGS=${cxxflags}" >> "$GITHUB_ENV"

      - name: cargo build (release)
        shell: bash
        run: cargo build --target ${{ matrix.target }} --release --bin codex

      - name: Stage binary (Linux/macOS)
        if: ${{ runner.os != 'Windows' }}
        shell: bash
        run: |
          set -euo pipefail
          dest="artifacts/${{ matrix.artifact_name }}"
          mkdir -p "$dest"
          cp "target/${{ matrix.target }}/release/codex" "$dest/codex"

      - name: Stage binary (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $dest = "artifacts/${{ matrix.artifact_name }}"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/codex.exe" "$dest/codex.exe"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: codex-rs/artifacts/${{ matrix.artifact_name }}

  publish_release_assets:
    name: Publish release assets
    runs-on: ubuntu-24.04
    needs: build_binaries
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.tag != '') }}
    steps:
      - name: Determine tag
        id: tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && -n "${INPUT_TAG}" ]]; then
            tag="${INPUT_TAG}"
          fi

          if [[ "${tag}" != chutes-v* ]]; then
            echo "::error::Expected a chutes-v* tag, got '${tag}'"
            exit 1
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Download binary artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: codex-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          shopt -s nullglob
          count=0
          for dir in release-artifacts/*; do
            name="$(basename "$dir")"
            if [[ -f "$dir/codex.exe" ]]; then
              cp "$dir/codex.exe" "release-assets/${name}.exe"
            elif [[ -f "$dir/codex" ]]; then
              cp "$dir/codex" "release-assets/${name}"
              chmod +x "release-assets/${name}"
            else
              echo "::error::No codex binary found in $dir"
              exit 1
            fi
            count=$((count + 1))
          done
          if [[ $count -eq 0 ]]; then
            echo "::error::No artifacts available to publish."
            exit 1
          fi

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            gh release create "${TAG}" --title "${TAG}" --notes "Automated build."
          fi

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${TAG}" release-assets/* --clobber

